<!DOCTYPE html>
<html>
<head>
    <title>OpenStack DefCore Tracked Capabilities</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" ></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.8.1/mustache.min.js"> </script>
    <script id="capabilities_template" type="x-tmpl-mustache">
    {{#capabilities}}
    <ul>
        <li><strong> {{name}} </strong></li>
        <ul>
            <li>Description: {{description}}</li>
            <li>Achivements: {{#achievements}} <a href="#{{.}}">#{{.}}</a> {{/achievements}}
            {{#admin}}<li><strong>Admin: true </strong></li>{{/admin}}
            {{#core}}<li><strong>Core: true </strong></li>{{/core}}</li>
            <li> <a onclick="$('#{{name}}').toggle(500);return false;" href="#"> Tests </a>
            <div id="{{name}}" style="display:none;">
            <ul>
                {{#tests}} <li> {{.}} {{#code_url}} {{.}} {{/code_url}} </li> {{/tests}}
            </ul>
            <div>
            </li>

        </ul>
    </ul>
    {{/capabilities}}
    </script>
    <script id="criteria_template" type="x-tmpl-mustache">
    {{#criteria}}
    <ul>
        <li><strong> <a id="{{tag}}"> #{{tag}} <a> </strong></li>
        <ul>
            <li>Name: {{name}} </li>
            <li>Description: {{Description}} </li>
            <li>Weight: {{weight}} </li>
        </ul>
    </ul>
    {{/criteria}}
    </script>
    <script>
        function code_url(text, render){
            return render('<a onclick="get_code_url(\'' + text + ' \');" href="#"> [github] </a>' );
        }
        function get_code_url (test_id) {
            var arr = test_id.split('/');
            arr[0] = arr[0].replace(/\s+/g, '');
            var path_array = arr[0].split('.');
            var path = '';
            for(var i in path_array){
                path = path.concat('/', path_array[i]);

            }
            var test = arr[1].split('.').slice(-1)[0] + '(';
            test = test.replace(/\s+/g, '');
            var url = 'https://api.github.com/search/code' +
                    '?q='+test+' repo:openstack/tempest extension:py path:'+path;
            $.when($.ajax({type: 'GET', url: url, dataType: 'json'})).done(
                    function (data, status, xhr) {
                        if (data['items'].length < 1) {
                            alert('No test found !')
                        }
                        var html_url = data['items'][0]['html_url'];
                        $.when($.ajax({type: 'GET', url: data['items'][0]['git_url'], dataType: 'json'})).done(
                                function (data, status, xhr) {
                                    var content = window.atob(data['content']).split('\n');
                                    for (var i in content) {
                                        if (content[i].indexOf(test) > -1) {
                                            var line = parseInt(i) + 1;
                                            var url = html_url + '#L' + line;
                                            var win = window.open(url, '_blank');
                                            win.focus();
                                        }
                                    }
                                }
                        )
                    });

        }
        function render_caps(data){
            var template = $('#capabilities_template').html();
            var caps = {'capabilities': []};
            for(var name in data['capabilities']){
                var capability = data["capabilities"][name];
                capability['code_url'] = function(){
                    return code_url
                };
                caps['capabilities'].push(capability);
            }
            var rendered = Mustache.render(template, caps);

            $("ul#capabilities").html(rendered);
        }

        function render_criteria(data){
            var template = $('#criteria_template').html();
            var crits = {'criteria': []};
            for(var tag in data['criteria']){
                var criterion = data['criteria'][tag];
                criterion['tag'] = tag;
                crits['criteria'].push(criterion);
                }
            var rendered = Mustache.render(template, crits);

            $("ul#criteria").html(rendered);
        }

        function create_caps() {
            $.ajax({
                type: "GET",
                dataType: 'json',
                url: 'havanacore.json',
                success: function(data, status, xhr) {
                    render_caps(data);
                    render_criteria(data);
                }
            });
        }
        window.onload = create_caps();
    </script>
</head>

<body>

<h1>OpenStack DefCore Tracked Capabilities</h1>

<ul id="capabilities"></ul>

<h1>Criterion descriptions</h1>

<ul id="criteria"></ul>

<div>Copyright OpenStack Foundation, 2014.  Apache 2 License.</div>
</body>
</html> 
